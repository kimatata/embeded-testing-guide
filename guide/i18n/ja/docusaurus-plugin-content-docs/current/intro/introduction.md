---
sidebar_position: 1
---

import pyramid from "./img/pyramid.png";
import anti from "./img/anti.png";

# 組み込みソフトウェア開発の現状

私はとあるメーカーで組み込みソフトウェア開発をしています。それほど経験が豊富なわけではありませんが、私が経験したプロジェクトのソフトウェア開発プロセスは非常に遅れていました。テストコードは一切なく、テストはすべて手動で実行され、デグレが頻繁に発生し、リリースが遅れることはもはや日常茶飯事でした。

なぜテストの自動化を行わないのか？と上司や同僚に尋ねたところ、こんな答えが返ってきました。

- 「組み込みは実際にデバイスを動かさないとわからないからできないでしょ」
- 「テストコードとかってウェブ系の話だよね?」
- 「組み込みソフトは組み込みデバイス上で動くからそれをエミュレートするのは大変だよ」
- 「テストコードってなに?」

総じてテストの自動化なんて無理だよね。結局、今のやり方を続けるしかないんだよ、という感じです。

彼らの言っていることはわかります。ウェブ開発はブラウザという統一的な環境であり、Selenium[^1]やPlaywrite[^2]といったブラウザを自動操作するための優れたオープンソースのツールがあります。企業やプロジェクトごとに異なる無数の組み込みデバイスの一つをエミュレートするためのソフトを作るのはコストが釣り合わないでしょう（医療や宇宙開発分野のような一つのバグが致命的な損害につながるところなら必要だと思います）。

しかしそれはE2Eテストに限った話です。単体テストや統合テストが難しい理由にはなりません。組み込みソフトウェアもロジックの集合体である以上、単体テストで十分にバグを発見できるはずです。実際、手動テストや市場で見つかるバグのほとんどは分岐処理における条件ミスといったロジックに起因するものでした。これらは明らかに手動テストで発見すべき問題ではありません。単体テストで早期に見つけるべきバグです。私には、組み込みであることを言い訳に、自動化は無理だと早合点し、ソフトウェアテストに関する十分な知識を得ようともせずに、現状の方法に固執しているように感じられました。

## テストの種類

テストを導入するにはある程度の工数がかかるため、その投資をどれくらいの期間で回収できるかが重要です。E2Eテストは、実行時間が長く、開発者がフィードバックを得るまでに時間がかかります。また、テストのスコープの大きさから、仕様変更に影響を受けやすく、テストが壊れやすい特徴があります。それに対し、単体テストは実行時間が短く、開発者は迅速なフィードバックが得られます。スコープも小さく、仕様変更の影響を受けにくいです。当然私が組み込みソフト開発に導入したいテスト自動化はより早くリターンを得られる単体テストになります。Googleでも全テストのうち約80%を単体テストで構成することが推奨されています。[^3]

チームメンバーに自動テストを提案したとき、単体テストではなく手動テストの自動化に話がすり替わっていることに気づきました。これまでチームでは手動テストしか行っておらず、そもそも単体テストという発想自体がなかったため当然ですね。たとえば、人の代わりに手動テストを行うロボットを開発する、といった具合です。これは、ウェブ業界で（しばしばテストに詳しくない人々によって）キャプチャ&リプレイツールの導入が検討される事例に似ています。こうしたツールは手動テストの置き換えに過ぎず、テストの本質的な効率化や品質向上には直結しません。

<img src={pyramid} alt="テストピラミッド" width="300" /> [^4]

## 手動テスト100%

前述の通り、私の職場はすべてのバグを開発工程の終盤に手動テストで発見しようとしていました。これはテストピラミッドのアンチパターンとして知られている「アイスクリームコーン型」よりもさらにひどい状態であり、（単体テストが一切ないのでコーンもない）。ピラミッドの基盤すらない状態です。

<img src={anti} alt="アンチパターン" width="300" /> [^5]

このような非効率なテストの構成を見直し、手動テストにかかる工数の削減とバグの早期発見による品質向上を達成するため私は組み込みソフトウェア開発に単体テスト導入することを目指しました。実際、私が担当している製品に単体テストとCIを導入したことで、バグの発見がリリース前の手動テストフェーズから実装フェーズに早期化されました。カバレッジレポートにより分岐を網羅できているかどうかの確認が容易になり、テストの品質を定量化できるようになりました。

## チームの反応

私が単体テストを導入した成果をメンバーに紹介したところ、反応はまちまちでした。単体テストに興味を持ち、導入し始めてくれている人ももいれば、無関心な人もいました。

- とても良い! 私の担当製品にも導入したい
- なんかすごそうだけど実践方法がよくわからない
- 今のプロジェクトが忙しいから新しいこと覚えてる暇がない
- そもそも単体テストについてピンときていない

ということで、組み込みソフト開発チームにテストを根付かせる活動はまだ道半ばです。テスト導入の効果を引き続き紹介し、今後もテストの重要性を広める活動を続けていく予定です。

本ガイドは、私がチームに単体テストを導入する方法を説明した資料を一部修正したものです。テストの重要性はわかるけど組み込みで単体テストを導入する方法がわからない、という方にとって参考になれば嬉しいです。

[^1]: [https://www.selenium.dev/](https://www.selenium.dev/)
[^2]: [https://playwright.dev/](https://playwright.dev/)
[^3]: [Software Engineering at Google 16章 Testing Overview Test Scope](https://abseil.io/resources/swe-book/html/ch11.html)
[^4]: [Software Engineering at Google 16章 Testing Overview Figure 11-3](https://abseil.io/resources/swe-book/html/ch11.html)
[^5]: [Software Engineering at Google 16章 Testing Overview Figure 11-4](https://abseil.io/resources/swe-book/html/ch11.html)
